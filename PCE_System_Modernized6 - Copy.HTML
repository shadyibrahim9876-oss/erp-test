<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCE System - Odoo Style (Updated)</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // تفعيل الوضع المظلم اليدوي
            theme: {
                extend: {
                    colors: {
                        odooPurple: '#714B67',    // Primary
                        odooTeal: '#017E84',      // Action
                        odooDark: '#383E45',      // Sidebar
                        odooLight: '#F9F9F9',     // Bg
                        odooBorder: '#DEE2E6',    // Borders
                        odooText: '#374151',      // Text
                        odooDanger: '#DC3545',    // Danger
                        odooWarning: '#FC8213',   // Warning
                        
                        // Dark Mode Colors
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                        darkSidebar: '#020617',
                        darkBorder: '#334155',
                        darkText: '#f1f5f9'
                    },
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif'],
                        carrois: ['Carrois Gothic', 'sans-serif']
                    },
                    // Dynamic Island Animations
                    animation: {
                        'island-bounce': 'islandBounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'island-exit': 'islandExit 0.3s ease-in forwards'
                    },
                    keyframes: {
                        islandBounce: {
                            '0%': { transform: 'scale(0.8) translateY(-20px)', opacity: '0', borderRadius: '50px' },
                            '40%': { transform: 'scale(1.05) translateY(5px)', opacity: '1' },
                            '100%': { transform: 'scale(1) translateY(0)', opacity: '1', borderRadius: '24px' }
                        },
                        islandExit: {
                            '0%': { transform: 'scale(1)', opacity: '1' },
                            '100%': { transform: 'scale(0.9) translateY(-20px)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- 2. Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Carrois+Gothic&display=swap" rel="stylesheet">

    <!-- 3. React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .font-carrois { font-family: 'Carrois Gothic', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #2c3136; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #714B67; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #5d3d54; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slideUp { animation: slideUp 0.4s ease-out forwards; }
        
        /* Chat animations */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes chatBounce { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .chat-bubble { animation: chatBounce 0.3s ease-out; }
        
        /* Typing indicator */
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .typing-dot { animation: typing 1s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body class="bg-odooLight text-right w-full dark:bg-darkBg dark:text-darkText transition-colors duration-300">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useRef, createContext, useContext } = React;
    const apiKey = ""; // API Key

    // --- 1. Components ---
    const Icon = ({ name, size = 20, className = "" }) => {
        const [iconSvg, setIconSvg] = useState(null);
        useEffect(() => {
            if (window.lucide && window.lucide.icons) {
                const iconName = name.charAt(0).toUpperCase() + name.slice(1);
                const iconNode = window.lucide.icons[iconName];
                if (iconNode) {
                    const svgContent = iconNode.map(([tag, attrs]) => {
                        const attrString = Object.entries(attrs).map(([k,v]) => `${k}="${v}"`).join(' ');
                        return `<${tag} ${attrString}></${tag}>`;
                    }).join('');
                    setIconSvg(svgContent);
                }
            }
        }, [name]);
        if (!iconSvg) return <span className={`w-[${size}px] h-[${size}px]`}></span>;
        return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: iconSvg }} />;
    };

    // --- 2. App Context (For Dark Mode & Notifications) ---
    const AppContext = createContext();

    const AppProvider = ({ children }) => {
        // Dark Mode State
        const [darkMode, setDarkMode] = useState(() => localStorage.getItem('pce_theme') === 'dark');
        
        // Notification State
        const [notification, setNotification] = useState(null);

        useEffect(() => {
            if (darkMode) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('pce_theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('pce_theme', 'light');
            }
        }, [darkMode]);

        const notify = (type, message, sub = "") => {
            setNotification(null);
            setTimeout(() => {
                setNotification({ type, message, sub, active: true });
                setTimeout(() => {
                    setNotification(prev => prev ? { ...prev, active: false } : null);
                    setTimeout(() => setNotification(null), 300);
                }, 3500);
            }, 10);
        };

        return (
            <AppContext.Provider value={{ darkMode, setDarkMode, notify, notification }}>
                {children}
            </AppContext.Provider>
        );
    };

    // --- 3. Dynamic Island Component ---
    const DynamicIsland = () => {
        const { notification } = useContext(AppContext);
        if (!notification) return null;

        const { type, message, sub, active } = notification;
        const isExit = !active;
        
        let iconName = "CheckCircle2", iconColor = "text-green-500";
        if (type === 'error' || type === 'delete') { iconName = "AlertCircle"; iconColor = "text-red-500"; }
        else if (type === 'info') { iconName = "Info"; iconColor = "text-blue-400"; }

        return (
            <div className="fixed top-4 left-0 right-0 flex justify-center z-[9999] pointer-events-none">
                <div className={`pointer-events-auto flex items-center justify-between px-2 py-2 pr-4 bg-black/90 backdrop-blur-md text-white shadow-2xl border border-white/10 rounded-[30px] min-w-[200px] max-w-[90%] transition-all duration-500 ${isExit ? 'animate-island-exit' : 'animate-island-bounce'}`}>
                    <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full bg-white/10 flex items-center justify-center ${iconColor}`}>
                            <Icon name={iconName} size={22} />
                        </div>
                        <div className="flex flex-col justify-center text-right pl-4">
                            <span className="text-sm font-bold leading-tight">{message}</span>
                            {sub && <span className="text-[11px] text-gray-400 leading-tight mt-0.5">{sub}</span>}
                        </div>
                    </div>
                    <div className="flex items-center gap-1 h-4 mx-2">
                        <div className={`w-1 bg-${type === 'delete' ? 'red' : 'green'}-500 rounded-full animate-[bounce_1s_infinite] h-3`}></div>
                        <div className={`w-1 bg-${type === 'delete' ? 'red' : 'green'}-500 rounded-full animate-[bounce_1s_infinite_0.2s] h-5`}></div>
                        <div className={`w-1 bg-${type === 'delete' ? 'red' : 'green'}-500 rounded-full animate-[bounce_1s_infinite_0.4s] h-2`}></div>
                    </div>
                </div>
            </div>
        );
    };

    // --- 4. Helpers & Mock Data ---
    const INITIAL_STORES = [
        { id: 1002, name: "مخزن اكتوبر", code: "OCTOMER", address: "6 أكتوبر", phone1: "01093793055", remarks: "رئيسي" },
        { id: 4, name: "مخزن اسكندرية", code: "ALEX", address: "العجمي", phone1: "0123456789", remarks: "" },
        { id: 3, name: "مخزن دمنهور", code: "DAM", address: "دمنهور", phone1: "045123456", remarks: "" },
        { id: 2, name: "مخزن أبوحمص", code: "ABU", address: "أبو حمص", phone1: "", remarks: "" },
        { id: 1, name: "المحل", code: "MAR", address: "الفرع الرئيسي", phone1: "04525152", remarks: "11" },
    ];

    async function callGeminiAPI(prompt, jsonMode = false) {
        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const generationConfig = jsonMode ? { responseMimeType: "application/json" } : undefined;
            const response = await fetch(url, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig })
            });
            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
        } catch (error) { console.error(error); return ""; }
    }

    // --- 5. Full Sidebar Structure ---
    const MENU_STRUCTURE = [
        { id: 'dashboard', label: 'الرئيسية', icon: 'LayoutDashboard', subItems: [] },
        { id: 'master-data', label: 'بيانات رئيسية', icon: 'Database', subItems: [
            { id: 'stores', label: 'المخازن' }, { id: 'customers', label: 'العملاء' }, { id: 'suppliers', label: 'الموردين' }, 
            { id: 'safes', label: 'الخزائن' }, { id: 'banks', label: 'البنوك' }, { id: 'items', label: 'البنود' },
            { id: 'employees', label: 'الموظفين' }, { id: 'departments', label: 'الأقسام' }
        ]},
        { id: 'finance', label: 'شئون مالية', icon: 'Banknote', subItems: [
            { id: 'cash-receipt', label: 'استلام نقدية' }, { id: 'cash-payment', label: 'صرف نقدية' }, 
            { id: 'bank-receipt', label: 'استلام بنكي' }, { id: 'journal', label: 'القيود اليومية' }, { id: 'tax', label: 'الضرائب' }
        ]},
        { id: 'transport', label: 'النقل', icon: 'Truck', subItems: [{ id: 'transport-prices', label: 'أسعار النقل' }] },
        { id: 'files', label: 'الملفات', icon: 'FileText', subItems: [{ id: 'all-files', label: 'ملفات العمل' }, { id: 'quotations', label: 'عروض الأسعار' }, { id: 'work-orders', label: 'أوامر الشغل' }] },
        { id: 'accounts', label: 'الحسابات', icon: 'Calculator', subItems: [{ id: 'trial-balance', label: 'ميزان المراجعة' }, { id: 'chart-accounts', label: 'شجرة الحسابات' }, { id: 'cost-centers', label: 'مراكز التكلفة' }] },
        { id: 'purchasing', label: 'المشتريات', icon: 'ShoppingCart', subItems: [{ id: 'purch-invoice', label: 'فاتورة مشتريات' }, { id: 'purch-report', label: 'تقرير المشتريات' }, { id: 'suppliers-debt', label: 'مديونية الموردين' }] },
        { id: 'sales', label: 'المبيعات', icon: 'TrendingUp', subItems: [{ id: 'sales-invoice', label: 'فاتورة مبيعات' }, { id: 'sales-report', label: 'تقرير المبيعات' }, { id: 'customers-debt', label: 'مديونية العملاء' }] },
        { id: 'settings', label: 'ضبط', icon: 'Settings', subItems: [{id: 'users', label: 'المستخدمين'}, {id: 'roles', label: 'الأدوار'}] },
        { id: 'reports', label: 'التقارير', icon: 'FileBarChart', subItems: [{id: 'profit-loss', label: 'الأرباح والخسائر'}] },
        { id: 'crm', label: 'CRM', icon: 'Users', subItems: [{id: 'tasks', label: 'المهمات'}] },
    ];

    // --- 6. Components ---

    const Sidebar = ({ isOpen, activePage, setActivePage }) => {
        const [expandedMenus, setExpandedMenus] = useState({});
        const toggleMenu = (id) => { if (!isOpen) return; setExpandedMenus(p => ({ ...p, [id]: !p[id] })); };

        return (
            <aside className={`fixed top-0 right-0 h-full bg-odooDark dark:bg-darkSidebar text-gray-300 z-30 transition-all duration-300 ${isOpen ? 'w-[260px]' : 'w-[70px]'} flex flex-col shadow-2xl dark:border-l dark:border-white/5`}>
                <div className="h-16 flex items-center justify-center border-b border-gray-600/50 bg-black/20 shrink-0">
                    <h1 className={`text-odooPurple dark:text-purple-400 font-black tracking-widest transition-all ${isOpen ? 'text-xl' : 'text-xs'}`}>{isOpen ? 'PCE SYSTEM' : 'PCE'}</h1>
                </div>
                <nav className="flex-1 overflow-y-auto py-4 space-y-1 custom-scrollbar">
                    {MENU_STRUCTURE.map(item => {
                        const isActive = activePage === item.id || item.subItems.some(sub => sub.id === activePage);
                        const isExpanded = expandedMenus[item.id];
                        return (
                            <div key={item.id}>
                                <button onClick={() => item.subItems.length > 0 ? toggleMenu(item.id) : setActivePage(item.id)} 
                                    className={`w-full flex items-center justify-between px-4 py-3 transition-all relative group ${isActive ? 'text-white bg-white/10' : 'hover:bg-white/5 hover:text-white'} ${isActive && !isExpanded && !isOpen ? 'border-r-4 border-odooTeal' : ''}`} title={!isOpen ? item.label : ''}>
                                    <div className={`flex items-center gap-3 ${!isOpen && 'w-full justify-center'}`}>
                                        <Icon name={item.icon} size={20} className={`${isActive ? 'text-odooTeal dark:text-purple-400' : 'text-gray-400 group-hover:text-white'}`} />
                                        {isOpen && <span className="text-sm font-medium">{item.label}</span>}
                                    </div>
                                    {isOpen && item.subItems.length > 0 && <Icon name="ChevronDown" size={14} className={`transition-transform ${isExpanded ? 'rotate-180' : ''} opacity-50`} />}
                                </button>
                                {isOpen && isExpanded && item.subItems.length > 0 && (
                                    <div className="bg-black/20 overflow-hidden animate-fadeIn">
                                        {item.subItems.map(sub => (
                                            <button key={sub.id} onClick={() => setActivePage(sub.id)} className={`w-full flex items-center gap-2 pr-12 pl-4 py-2 text-sm hover:text-white transition ${activePage === sub.id ? 'text-odooTeal font-bold' : 'text-gray-400'}`}>
                                                <div className={`w-1.5 h-1.5 rounded-full ${activePage === sub.id ? 'bg-odooTeal' : 'bg-gray-600'}`}></div>{sub.label}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )
                    })}
                </nav>
                {isOpen && <div className="p-4 border-t border-gray-700 bg-black/10 flex gap-3 items-center"><img src="https://ui-avatars.com/api/?name=Tarek&background=714B67&color=fff" className="w-8 h-8 rounded-full" /><div><p className="text-sm font-bold text-white">Tarek</p><p className="text-xs text-gray-400">مدير</p></div></div>}
            </aside>
        );
    };

    const ChartPlaceholder = ({ title, color }) => (
        <div className="bg-white dark:bg-darkCard p-4 rounded-lg shadow-sm border border-odooBorder dark:border-darkBorder h-64 flex flex-col transition-colors">
            <h3 className="text-gray-700 dark:text-gray-200 font-bold mb-4 flex items-center gap-2">
                <Icon name="TrendingUp" size={18} className={`text-${color}`} /> {title}
            </h3>
            <div className="flex-1 flex items-end justify-between gap-2 px-2 pb-2">
                {[40, 70, 45, 90, 60, 80, 50].map((h, i) => (
                    <div key={i} className="w-full bg-gray-100 dark:bg-white/5 rounded-t-md relative group">
                        <div style={{ height: `${h}%`, backgroundColor: color }} className="w-full absolute bottom-0 rounded-t-md transition-all duration-500 hover:opacity-80"></div>
                        <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">{h}%</div>
                    </div>
                ))}
            </div>
        </div>
    );

    const Dashboard = () => {
        return (
            <div className="animate-fadeIn space-y-6">
                <div className="flex flex-wrap justify-between items-center gap-4 w-full relative z-10">
                    <h2 className="text-2xl font-bold text-odooPurple dark:text-purple-400">لوحة المعلومات</h2>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    {[
                        { title: "المبيعات", val: "150,000", icon: "Banknote", color: "text-odooPurple" },
                        { title: "الفواتير", val: "45", icon: "FileText", color: "text-odooTeal" },
                        { title: "العملاء", val: "1,205", icon: "Users", color: "text-blue-600" },
                        { title: "المهام", val: "12", icon: "CheckSquare", color: "text-odooWarning" }
                    ].map((stat, i) => (
                        <div key={i} className="bg-white dark:bg-darkCard p-5 rounded border border-odooBorder dark:border-darkBorder shadow-sm flex justify-between items-center transition-colors">
                            <div><p className="text-gray-500 dark:text-gray-400 text-sm">{stat.title}</p><h3 className={`text-2xl font-bold ${stat.color} dark:text-white`}>{stat.val}</h3></div>
                            <div className={`bg-opacity-10 p-3 rounded ${stat.color.replace('text', 'bg')} ${stat.color} dark:text-white dark:bg-white/10`}><Icon name={stat.icon} /></div>
                        </div>
                    ))}
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <ChartPlaceholder title="تحليل المبيعات الأسبوعي" color="#714B67" />
                    <ChartPlaceholder title="حركة المخازن" color="#017E84" />
                </div>
            </div>
        );
    };

    const Header = ({ onToggle }) => {
        const [date, setDate] = useState(new Date());
        const { darkMode, setDarkMode } = useContext(AppContext);
        useEffect(() => { const timer = setInterval(() => setDate(new Date()), 1000); return () => clearInterval(timer); }, []);

        return (
            <header className="fixed top-0 left-0 right-0 bg-white dark:bg-darkCard border-b-4 border-odooPurple h-16 flex items-center justify-between px-4 shadow-sm z-40 dark:border-b dark:border-purple-900 transition-colors">
                <div className="flex items-center gap-3">
                    <button onClick={onToggle} className="p-2 text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 rounded"><Icon name="Menu" size={24} /></button>
                    <span className="font-bold text-lg text-odooPurple dark:text-purple-400 hidden md:block">PCE System</span>
                </div>
                <div className="flex items-center gap-4">
                    <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 text-gray-600 dark:text-yellow-400 transition-transform hover:scale-110">
                        <Icon name={darkMode ? "Sun" : "Moon"} size={20} />
                    </button>
                    <div className="hidden md:block text-sm font-bold text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-white/5 px-3 py-1 rounded">
                        {date.toLocaleDateString('ar-EG')}
                    </div>
                    <div className="flex items-center gap-3 text-gray-500 dark:text-gray-400 border-r border-gray-200 dark:border-darkBorder pr-4">
                        <div className="relative cursor-pointer hover:text-odooPurple dark:hover:text-white"><Icon name="Bell" size={20} /><span className="absolute -top-1 -right-1 bg-red-500 w-2 h-2 rounded-full"></span></div>
                    </div>
                </div>
            </header>
        );
    };

    const AIModal = ({ isOpen, onClose, content, isLoading, title }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fadeIn">
                <div className="bg-white dark:bg-darkCard rounded-lg shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[80vh] transition-colors">
                    <div className="bg-odooPurple p-4 flex justify-between items-center text-white">
                        <div className="flex items-center gap-2"><Icon name="Sparkles" size={20} className="animate-pulse" /><h3 className="font-bold">{title}</h3></div>
                        <button onClick={onClose}><Icon name="X" size={20} /></button>
                    </div>
                    <div className="p-6 overflow-y-auto flex-1 text-gray-700 dark:text-gray-200 leading-relaxed whitespace-pre-line">
                        {isLoading ? (
                            <div className="flex flex-col items-center justify-center py-10 gap-3 text-gray-500 dark:text-gray-400">
                                <Icon name="Loader2" className="animate-spin text-odooPurple dark:text-purple-400" size={32} />
                                <p>جاري المعالجة...</p>
                            </div>
                        ) : content}
                    </div>
                    <div className="p-4 border-t border-gray-200 dark:border-darkBorder bg-gray-50 dark:bg-black/20 flex justify-end">
                        <button onClick={onClose} className="bg-odooDark text-white px-5 py-2 rounded hover:bg-opacity-90 text-sm">إغلاق</button>
                    </div>
                </div>
            </div>
        );
    };

    const StoreFormModal = ({ isOpen, onClose, onSave, initialData }) => {
        const [formData, setFormData] = useState({ name: '', code: '', address: '', phone1: '', remarks: '' });
        const [smartInput, setSmartInput] = useState('');
        const [loading, setLoading] = useState(false);
        const [showSmart, setShowSmart] = useState(false);
        const { notify } = useContext(AppContext);

        useEffect(() => {
            if (initialData) setFormData(initialData);
            else setFormData({ name: '', code: '', address: '', phone1: '', remarks: '' });
            setSmartInput(''); setShowSmart(false);
        }, [initialData, isOpen]);

        if (!isOpen) return null;

        const handleSmart = async () => {
            if (!smartInput) return;
            setLoading(true);
            const res = await callGeminiAPI(`Extract JSON {name, code, address, phone1, remarks} from: "${smartInput}"`, true);
            try { 
                const parsedData = JSON.parse(res);
                setFormData(prev => ({ ...prev, ...parsedData })); 
                setShowSmart(false); 
                notify('success', 'تم استخراج البيانات بنجاح'); 
            } 
            catch(e){ 
                notify('error', 'فشل في تحليل البيانات'); 
            }
            setLoading(false);
        };

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fadeIn">
                <div className="bg-white dark:bg-darkCard rounded-lg shadow-2xl w-full max-w-lg overflow-hidden transition-colors">
                    <div className="bg-odooPurple p-4 flex justify-between items-center text-white">
                        <h3 className="font-bold">{initialData ? 'تعديل بيانات' : 'إضافة مخزن جديد'}</h3>
                        <button onClick={onClose}><Icon name="X" size={20} /></button>
                    </div>
                    <div className="p-6 overflow-y-auto max-h-[70vh] space-y-4">
                        {!initialData && (
                            <div className="bg-purple-50 dark:bg-purple-900/10 p-3 rounded border border-purple-100 dark:border-purple-900/30">
                                <button onClick={() => setShowSmart(!showSmart)} className="flex items-center justify-between w-full text-odooPurple dark:text-purple-400 font-bold text-sm">
                                    <span className="flex items-center gap-2"><Icon name="Sparkles" size={16} /> تعبئة ذكية (AI)</span>
                                    <Icon name="ChevronDown" size={16} className={showSmart ? 'rotate-180' : ''} />
                                </button>
                                {showSmart && (
                                    <div className="mt-2 animate-fadeIn">
                                        <textarea className="w-full p-2 border dark:border-darkBorder rounded text-sm dark:bg-darkSidebar dark:text-white" rows="2" placeholder="مثال: مخزن الدقي شارع التحرير..." value={smartInput} onChange={e => setSmartInput(e.target.value)} />
                                        <button onClick={handleSmart} disabled={loading} className="mt-2 w-full bg-odooTeal text-white py-1.5 rounded text-sm font-bold flex justify-center gap-2 hover:bg-teal-700 transition">
                                            {loading ? <Icon name="Loader2" className="animate-spin" size={16} /> : "استخراج البيانات"}
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                        <div className="grid grid-cols-1 gap-4">
                            <div><label className="text-sm font-bold text-gray-700 dark:text-gray-300">اسم المخزن</label><input value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full border dark:border-darkBorder p-2 rounded focus:border-odooPurple outline-none dark:bg-darkSidebar dark:text-white" /></div>
                            <div><label className="text-sm font-bold text-gray-700 dark:text-gray-300">الكود</label><input value={formData.code} onChange={e => setFormData({...formData, code: e.target.value})} className="w-full border dark:border-darkBorder p-2 rounded focus:border-odooPurple outline-none dark:bg-darkSidebar dark:text-white" /></div>
                            <div><label className="text-sm font-bold text-gray-700 dark:text-gray-300">العنوان</label><input value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} className="w-full border dark:border-darkBorder p-2 rounded focus:border-odooPurple outline-none dark:bg-darkSidebar dark:text-white" /></div>
                            <div><label className="text-sm font-bold text-gray-700 dark:text-gray-300">الهاتف</label><input value={formData.phone1} onChange={e => setFormData({...formData, phone1: e.target.value})} className="w-full border dark:border-darkBorder p-2 rounded focus:border-odooPurple outline-none dark:bg-darkSidebar dark:text-white" /></div>
                            <div><label className="text-sm font-bold text-gray-700 dark:text-gray-300">ملاحظات</label><textarea value={formData.remarks} onChange={e => setFormData({...formData, remarks: e.target.value})} className="w-full border dark:border-darkBorder p-2 rounded focus:border-odooPurple outline-none dark:bg-darkSidebar dark:text-white" rows="2"></textarea></div>
                        </div>
                    </div>
                    <div className="p-4 border-t border-gray-200 dark:border-darkBorder bg-gray-50 dark:bg-black/10 flex justify-end gap-2">
                        <button onClick={onClose} className="px-4 py-2 border dark:border-darkBorder rounded text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/5 text-sm font-bold">إلغاء</button>
                        <button onClick={() => onSave(formData)} className="px-6 py-2 bg-odooPurple text-white rounded hover:bg-purple-800 text-sm font-bold flex items-center gap-2 transition"><Icon name="Save" size={16} /> حفظ</button>
                    </div>
                </div>
            </div>
        );
    };

    const DataTable = ({ columns, data = [], onEdit, onDelete, title, aiAction }) => {
        const [selected, setSelected] = useState([]);
        const handleSelectAll = (e) => setSelected(e.target.checked ? data.map(r => r.id) : []);
        
        return (
            <div className="bg-white dark:bg-darkCard rounded shadow-sm border border-odooBorder dark:border-darkBorder overflow-hidden transition-colors">
                <div className="p-4 border-b border-odooBorder dark:border-darkBorder flex flex-wrap justify-between items-center bg-white dark:bg-darkCard">
                    <div className="flex items-center gap-3">
                        <h3 className="text-lg font-bold text-odooPurple dark:text-purple-400 flex items-center gap-2"><Icon name="Database" size={20} /> {title}</h3>
                        {selected.length > 0 ? (
                            <button onClick={() => { onDelete(selected); setSelected([]); }} className="flex items-center gap-1 bg-odooDanger text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-700 transition"><Icon name="Trash2" size={14} /> حذف ({selected.length})</button>
                        ) : (
                            aiAction && <button onClick={aiAction} className="flex items-center gap-1 text-odooTeal border border-odooTeal px-3 py-1 rounded text-xs font-bold hover:bg-odooTeal hover:text-white transition-colors"><Icon name="Sparkles" size={14} /> تحليل</button>
                        )}
                    </div>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-right text-sm text-odooText dark:text-darkText">
                        <thead className="bg-gray-50 dark:bg-black/20 text-xs uppercase font-bold text-gray-500 dark:text-gray-400 border-b dark:border-darkBorder">
                            <tr>
                                <th className="p-3 w-10 text-center"><input type="checkbox" className="accent-odooPurple" onChange={handleSelectAll} checked={data.length > 0 && selected.length === data.length} /></th>
                                {columns.map(c => <th key={c.key} className="p-3">{c.label}</th>)}
                                <th className="p-3 w-20"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map(row => (
                                <tr key={row.id} className={`border-b dark:border-darkBorder hover:bg-gray-50 dark:hover:bg-white/5 group ${selected.includes(row.id) ? 'bg-purple-50 dark:bg-purple-900/20' : ''}`} onDoubleClick={() => onEdit(row)}>
                                    <td className="p-3 text-center"><input type="checkbox" className="accent-odooPurple" checked={selected.includes(row.id)} onChange={() => setSelected(prev => prev.includes(row.id) ? prev.filter(i => i !== row.id) : [...prev, row.id])} /></td>
                                    {columns.map(c => <td key={c.key} className="p-3">{row[c.key]}</td>)}
                                    <td className="p-3 text-center"><button onClick={() => onEdit(row)} className="text-odooTeal hover:text-odooPurple dark:text-teal-400 dark:hover:text-purple-400 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="Edit" size={16} /></button></td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );
    };

    const StoresPage = () => {
        const [stores, setStores] = useState(INITIAL_STORES);
        const [isForm, setIsForm] = useState(false);
        const [editing, setEditing] = useState(null);
        const [isAi, setIsAi] = useState(false);
        const [aiContent, setAiContent] = useState("");
        const [loading, setLoading] = useState(false);
        const { notify } = useContext(AppContext);

        const handleSave = (d) => {
            if (editing) { 
                setStores(prev => prev.map(s => s.id === editing.id ? {...d, id: editing.id} : s)); 
                notify('success', 'تم تعديل بيانات المخزن بنجاح'); 
            } 
            else { 
                setStores(prev => [...prev, {...d, id: Date.now()}]); 
                notify('success', 'تم إضافة المخزن الجديد بنجاح'); 
            }
            setIsForm(false);
        };
        
        const deleteStores = (ids) => { 
            setStores(prev => prev.filter(s => !ids.includes(s.id))); 
            notify('delete', `تم حذف ${ids.length} مخزن`); 
        };

        const handleAi = async () => {
            setIsAi(true); 
            setLoading(true); 
            setAiContent("");
            const res = await callGeminiAPI(`حلل بيانات المخازن: ${JSON.stringify(stores)}`);
            setAiContent(res || "عذراً، لم أستطع تحليل البيانات حالياً. يرجى المحاولة مرة أخرى."); 
            setLoading(false);
        };

        return (
            <div className="space-y-6 animate-fadeIn">
                <div className="flex justify-end">
                    <button onClick={() => { setEditing(null); setIsForm(true); }} className="bg-odooTeal text-white px-4 py-2 rounded shadow hover:bg-teal-700 text-sm font-bold flex items-center gap-2 transition">
                        <Icon name="Plus" size={18} /> جديد
                    </button>
                </div>
                <DataTable 
                    title="المخازن" 
                    columns={[
                        { key: 'name', label: 'الاسم' }, 
                        { key: 'code', label: 'الكود' }, 
                        { key: 'address', label: 'العنوان' },
                        { key: 'phone1', label: 'الهاتف' }
                    ]} 
                    data={stores} 
                    onEdit={i => { setEditing(i); setIsForm(true); }} 
                    onDelete={deleteStores} 
                    aiAction={handleAi} 
                />
                <StoreFormModal isOpen={isForm} onClose={() => setIsForm(false)} onSave={handleSave} initialData={editing} />
                <AIModal isOpen={isAi} onClose={() => setIsAi(false)} content={aiContent} isLoading={loading} title="تحليل بيانات المخازن" />
            </div>
        );
    };

    // --- 9. AI Chat Assistant (محدث ومطور) ---
    const ChatAssistant = () => {
        const [isOpen, setIsOpen] = useState(false);
        const [messages, setMessages] = useState([{ 
            role: 'bot', 
            text: 'مرحباً! أنا مساعد PCE الذكي. كيف يمكنني مساعدتك اليوم؟' 
        }]);
        const [input, setInput] = useState('');
        const [isTyping, setIsTyping] = useState(false);
        const messagesEndRef = useRef(null);
        
        // تمرير للأسفل عند إضافة رسائل جديدة
        const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        };
        
        useEffect(() => {
            scrollToBottom();
        }, [messages]);

        const handleSend = async () => {
            if (!input.trim()) return;
            
            const userMessage = input.trim();
            setInput('');
            setMessages(prev => [...prev, { role: 'user', text: userMessage }]);
            setIsTyping(true);
            
            try {
                const res = await callGeminiAPI(userMessage);
                setMessages(prev => [...prev, { 
                    role: 'bot', 
                    text: res || "عذراً، لم أستطع معالجة طلبك حالياً. يرجى المحاولة مرة أخرى." 
                }]);
            } catch (error) {
                setMessages(prev => [...prev, { 
                    role: 'bot', 
                    text: "حدث خطأ أثناء الاتصال. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى." 
                }]);
            }
            
            setIsTyping(false);
        };

        const handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        };

        return (
            <div className="fixed bottom-6 left-6 z-[100] flex flex-col items-end font-cairo">
                {isOpen && (
                    <div className="mb-4 w-80 h-96 bg-white dark:bg-darkCard rounded-lg shadow-xl border dark:border-darkBorder flex flex-col overflow-hidden animate-slideUp">
                        <div className="bg-odooPurple p-3 text-white flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Icon name="Bot" size={18} />
                                <span className="font-bold">المساعد الذكي</span>
                            </div>
                            <button onClick={() => setIsOpen(false)} className="hover:bg-white/10 p-1 rounded">
                                <Icon name="X" size={16} />
                            </button>
                        </div>
                        
                        <div className="flex-1 p-3 overflow-y-auto space-y-2 custom-scrollbar">
                            {messages.map((m, i) => (
                                <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] p-2 px-3 rounded-lg ${m.role === 'user' 
                                        ? 'bg-odooTeal text-white rounded-br-none' 
                                        : 'bg-gray-100 dark:bg-white/10 text-gray-800 dark:text-white rounded-bl-none'}`}>
                                        {m.text}
                                    </div>
                                </div>
                            ))}
                            
                            {isTyping && (
                                <div className="flex justify-start">
                                    <div className="bg-gray-100 dark:bg-white/10 p-2 px-3 rounded-lg rounded-bl-none flex items-center">
                                        <div className="flex space-x-1">
                                            <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                                            <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                                            <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                                        </div>
                                        <span className="mr-2 text-xs text-gray-500">يكتب...</span>
                                    </div>
                                </div>
                            )}
                            
                            <div ref={messagesEndRef} />
                        </div>
                        
                        <div className="p-3 border-t dark:border-darkBorder flex items-center">
                            <input 
                                className="flex-1 p-2 rounded-l border dark:border-darkBorder outline-none dark:bg-darkSidebar dark:text-white" 
                                value={input} 
                                onChange={e => setInput(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="اكتب رسالتك هنا..."
                                disabled={isTyping}
                            />
                            <button 
                                onClick={handleSend} 
                                disabled={isTyping || !input.trim()}
                                className="bg-odooPurple text-white p-2 rounded-r hover:bg-purple-800 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <Icon name="Send" size={16} />
                            </button>
                        </div>
                    </div>
                )}
                
                <button 
                    onClick={() => setIsOpen(!isOpen)} 
                    className="bg-odooPurple text-white p-3.5 rounded-full shadow-lg hover:bg-purple-800 transition-all transform hover:scale-110"
                >
                    <Icon name={isOpen ? "X" : "MessageCircle"} size={24} />
                </button>
            </div>
        );
    };

    // --- 10. Main App ---
    const App = () => {
        const [sidebarOpen, setSidebarOpen] = useState(true);
        const [page, setPage] = useState('dashboard');

        useEffect(() => {
            const resize = () => setSidebarOpen(window.innerWidth > 1024);
            window.addEventListener('resize', resize); 
            resize(); 
            return () => window.removeEventListener('resize', resize);
        }, []);

        return (
            <div className="min-h-screen flex flex-col">
                <AppProvider>
                    <Header onToggle={() => setSidebarOpen(!sidebarOpen)} />
                    <Sidebar isOpen={sidebarOpen} activePage={page} setActivePage={setPage} />
                    <main className={`flex-1 pt-20 p-6 transition-all duration-300 ${sidebarOpen ? 'mr-[260px]' : 'mr-[70px]'}`}>
                        {page === 'dashboard' && <Dashboard />}
                        {page === 'stores' && <StoresPage />}
                        {page !== 'dashboard' && page !== 'stores' && (
                            <div className="h-[60vh] flex flex-col items-center justify-center text-gray-400">
                                <Icon name="Settings" size={64} className="mb-4" />
                                <span className="text-xl">صفحة "{MENU_STRUCTURE.flatMap(m => m.subItems).find(s => s?.id === page)?.label || page}" قيد الإنشاء</span>
                                <p className="text-sm mt-2 text-gray-500">سيتم إضافتها قريباً</p>
                            </div>
                        )}
                    </main>
                    <ChatAssistant />
                    <DynamicIsland />
                </AppProvider>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>